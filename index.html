<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RSA QR Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
</head>
<body class="bg-gray-100 font-sans">
  <!-- LOGIN PAGE -->
  <div id="loginPage" class="flex items-center justify-center h-screen">
    <div class="bg-white p-6 rounded shadow-md w-80">
      <h2 class="text-xl font-bold text-center mb-4">ğŸ” Login RSA Tool</h2>
      <input type="text" id="username" placeholder="Username" class="w-full border px-2 py-1 mb-3 rounded">
      <input type="password" id="password" placeholder="Password" class="w-full border px-2 py-1 mb-4 rounded">
      <button onclick="login()" class="bg-blue-600 text-white px-4 py-2 rounded w-full">Login</button>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="appPage" class="hidden p-6">
    <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-md p-6">
      <h2 class="text-2xl font-bold mb-6 text-center">ğŸ” RSA Encryption & QR Tool</h2>

      <!-- MENU -->
      <div class="flex justify-center space-x-4 mb-6">
        <button onclick="showTab('encrypt')" class="bg-green-600 text-white px-4 py-2 rounded">Enkripsi</button>
        <button onclick="showTab('decrypt')" class="bg-red-600 text-white px-4 py-2 rounded">Dekripsi</button>
      </div>

      <!-- ENCRYPT MENU -->
      <div id="encryptTab">
        <div class="grid grid-cols-2 gap-4 mb-4">
          <input type="number" id="p" placeholder="p (prime)" class="w-full border px-2 py-1 rounded">
          <input type="number" id="q" placeholder="q (prime)" class="w-full border px-2 py-1 rounded">
          <input type="number" id="e" placeholder="e (public exponent)" class="col-span-2 w-full border px-2 py-1 rounded">
        </div>
        <input type="text" id="plaintext" placeholder="Plaintext (ID Surat)" class="w-full border px-2 py-1 rounded mb-4">
        <button onclick="encrypt()" class="bg-green-700 text-white px-4 py-2 rounded w-full mb-4">ğŸ” Encrypt & Generate QR</button>
        <div class="grid grid-cols-2 gap-4 mb-4">
          <input type="text" id="n" placeholder="n" class="w-full border px-2 py-1 rounded bg-gray-100" readonly>
          <input type="text" id="d" placeholder="d" class="w-full border px-2 py-1 rounded bg-gray-100" readonly>
        </div>
        <canvas id="qrcode-canvas" class="mx-auto"></canvas>
        <button onclick="downloadQR()" class="mt-4 bg-purple-600 text-white px-4 py-2 rounded w-full">â¬‡ï¸ Simpan QR</button>
      </div>

      <!-- DECRYPT MENU -->
      <div id="decryptTab" class="hidden">
        <div class="grid grid-cols-2 gap-4 mb-4">
          <input type="number" id="p_dec" placeholder="p" class="w-full border px-2 py-1 rounded">
          <input type="number" id="q_dec" placeholder="q" class="w-full border px-2 py-1 rounded">
          <input type="number" id="e_dec" placeholder="e" class="col-span-2 w-full border px-2 py-1 rounded">
        </div>
        <div class="mb-4">
          <label class="text-sm font-semibold">ğŸ“· Upload QR Code:</label>
          <input type="file" accept="image/*" onchange="scanQR(event)" class="block mt-2">
        </div>

        <div class="mb-4">
          <label class="text-sm font-semibold">ğŸ“¸ atau Scan Kamera:</label>
          <div class="relative">
            <video id="video" class="w-full border rounded" autoplay></video>
            <canvas id="qr-canvas" class="hidden"></canvas>
          </div>
          <button onclick="startCamera()" class="bg-indigo-600 text-white px-4 py-2 rounded w-full mt-2">â–¶ï¸ Mulai Scan</button>
        </div>

        <textarea id="ciphertextInput" rows="4" class="w-full border px-2 py-1 rounded mb-4" placeholder="Hasil scan ciphertext QR akan muncul di sini..."></textarea>
        <button onclick="decrypt()" class="bg-red-700 text-white px-4 py-2 rounded w-full mb-4">ğŸ”“ Decrypt</button>
        <textarea id="decryptedText" rows="2" class="w-full border px-2 py-1 rounded bg-gray-100" readonly placeholder="Hasil Plaintext..."></textarea>
      </div>
    </div>
  </div>

  <!-- SCRIPT -->
  <script>
    const credentials = { username: "admin", password: "123456" };

    function login() {
      const user = document.getElementById("username").value;
      const pass = document.getElementById("password").value;
      if (user === credentials.username && pass === credentials.password) {
        document.getElementById("loginPage").style.display = "none";
        document.getElementById("appPage").classList.remove("hidden");
      } else {
        alert("Username atau password salah");
      }
    }

    function showTab(tab) {
      document.getElementById("encryptTab").style.display = tab === "encrypt" ? "block" : "none";
      document.getElementById("decryptTab").style.display = tab === "decrypt" ? "block" : "none";
    }

    function gcd(a, b) {
      while (b !== 0) [a, b] = [b, a % b];
      return a;
    }

    function modInverse(e, phi) {
      let [a, b, u] = [0, phi, 1];
      while (e > 0) {
        let q = Math.floor(b / e);
        [a, b, u, e] = [u, e, a - q * u, b - q * e];
      }
      return (b === 1) ? (a + phi) % phi : null;
    }

    function calculateKeys(p, q, e) {
      const n = p * q;
      const phi = (p - 1) * (q - 1);
      if (gcd(e, phi) !== 1) throw "e tidak coprime dengan Ï†(n)";
      const d = modInverse(e, phi);
      if (d === null) throw "Invers modular tidak ditemukan";
      return { n, d };
    }

    function encrypt() {
      try {
        const p = parseInt(document.getElementById("p").value);
        const q = parseInt(document.getElementById("q").value);
        const e = parseInt(document.getElementById("e").value);
        const plaintext = document.getElementById("plaintext").value;

        const { n, d } = calculateKeys(p, q, e);
        document.getElementById("n").value = n;
        document.getElementById("d").value = d;

        const ciphertext = Array.from(plaintext).map(ch => {
          const m = BigInt(ch.charCodeAt(0));
          return (m ** BigInt(e) % BigInt(n)).toString();
        }).join(" ");

        QRCode.toCanvas(document.getElementById("qrcode-canvas"), ciphertext, err => {
          if (err) alert("QR generation failed");
        });

        document.getElementById("ciphertextInput").value = "";
      } catch (err) {
        alert(err);
      }
    }

    function downloadQR() {
      const canvas = document.getElementById("qrcode-canvas");
      const link = document.createElement("a");
      link.href = canvas.toDataURL("image/png");
      link.download = "qr_ciphertext.png";
      link.click();
    }

    function scanQR(event) {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onload = function () {
        const img = new Image();
        img.onload = function () {
          const canvas = document.createElement("canvas");
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0);
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, canvas.width, canvas.height);
          if (code) {
            document.getElementById("ciphertextInput").value = code.data;
          } else {
            alert("QR tidak terbaca");
          }
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    }

    function decrypt() {
      try {
        const p = parseInt(document.getElementById("p_dec").value);
        const q = parseInt(document.getElementById("q_dec").value);
        const e = parseInt(document.getElementById("e_dec").value);
        const ciphertext = document.getElementById("ciphertextInput").value.trim().split(" ");

        const { n, d } = calculateKeys(p, q, e);
        const chars = ciphertext.map(c => {
          const m = BigInt(c) ** BigInt(d) % BigInt(n);
          return String.fromCharCode(Number(m));
        });

        document.getElementById("decryptedText").value = chars.join("");
      } catch (err) {
        alert("Dekripsi gagal: " + err);
      }
    }

    // QR CAMERA SCANNER
    let videoStream;
    function startCamera() {
      const video = document.getElementById("video");
      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => {
          videoStream = stream;
          video.srcObject = stream;
          video.setAttribute("playsinline", true);
          video.play();
          scanVideoFrame();
        }).catch(err => alert("Kamera gagal dimuat: " + err));
    }

    function scanVideoFrame() {
      const video = document.getElementById("video");
      const canvas = document.getElementById("qr-canvas");
      const ctx = canvas.getContext("2d");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, canvas.width, canvas.height);
      if (code) {
        document.getElementById("ciphertextInput").value = code.data;
        videoStream.getTracks().forEach(t => t.stop());
      } else {
        requestAnimationFrame(scanVideoFrame);
      }
    }
  </script>
</body>
</html>
