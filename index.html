<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login & RSA QR Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
</head>
<body class="bg-gray-100 p-6 font-sans">

  <!-- Login Section -->
  <div id="loginSection" class="max-w-md mx-auto bg-white rounded-xl shadow-md p-6">
    <h2 class="text-2xl font-bold mb-6 text-center">ğŸ” Login </h2>
    <label class="block mb-2 font-semibold">Username:</label>
    <input type="text" id="username" class="w-full border px-2 py-1 rounded mb-4" />
    <label class="block mb-2 font-semibold">Password:</label>
    <input type="password" id="password" class="w-full border px-2 py-1 rounded mb-6" />
    <button onclick="login()" class="bg-blue-600 text-white px-4 py-2 rounded w-full">Login</button>
    <p id="loginError" class="text-red-600 mt-4 hidden">Username atau password salah.</p>
  </div>

  <!-- Main App Section (hidden sebelum login) -->
  <div id="appSection" class="max-w-3xl mx-auto bg-white rounded-xl shadow-md p-6 hidden">
    <h2 class="text-2xl font-bold mb-6 text-center">ğŸ” RSA Encryption, QR Code & Decryption Tool</h2>

    <div class="grid grid-cols-2 gap-4 mb-4">
      <div>
        <label class="text-sm">p (prime):</label>
        <input type="number" id="p" class="w-full border px-2 py-1 rounded" />
      </div>
      <div>
        <label class="text-sm">q (prime):</label>
        <input type="number" id="q" class="w-full border px-2 py-1 rounded" />
      </div>
      <div class="col-span-2">
        <label class="text-sm">e (public exponent):</label>
        <input type="number" id="e" class="w-full border px-2 py-1 rounded" />
      </div>
    </div>

    <div class="mb-4">
      <label class="text-sm">Plaintext (ID Surat):</label>
      <input type="text" id="plaintext" class="w-full border px-2 py-1 rounded" />
    </div>

    <button onclick="encrypt()" class="bg-green-600 text-white px-4 py-2 rounded w-full mb-4">
      ğŸ” Encrypt & Generate QR
    </button>

    <div class="grid grid-cols-2 gap-4 mb-4">
      <div>
        <label class="text-sm">n:</label>
        <input type="text" id="n" class="w-full border px-2 py-1 rounded bg-gray-100" readonly />
      </div>
      <div>
        <label class="text-sm">d:</label>
        <input type="text" id="d" class="w-full border px-2 py-1 rounded bg-gray-100" readonly />
      </div>
    </div>

    <div class="text-center mb-6">
      <canvas id="qrcode-canvas" class="mx-auto"></canvas>
      <button onclick="downloadQR()" class="mt-2 bg-purple-600 text-white px-4 py-2 rounded">
        â¬‡ï¸ Simpan QR Code
      </button>
    </div>

    <hr class="my-6" />

    <div class="mb-4">
      <label class="text-sm font-semibold">ğŸ“· Upload QR Code Image to Decrypt:</label>
      <input
        type="file"
        id="qrUpload"
        accept="image/*"
        onchange="scanQR(event)"
        class="block mt-2"
      />
    </div>

    <div class="mb-4">
      <button onclick="startCameraScan()" class="bg-blue-600 text-white px-4 py-2 rounded w-full mb-2">
        ğŸ“· Scan QR Code dari Kamera
      </button>
      <video
        id="video"
        style="width: 100%; max-width: 400px; border: 1px solid #ccc; display: none;"
      ></video>
      <button
        onclick="stopCameraScan()"
        id="stopScanBtn"
        class="bg-red-600 text-white px-4 py-2 rounded w-full mt-2"
        style="display:none;"
      >
        âœ‹ Stop Scan
      </button>
    </div>

    <div class="mb-4">
      <label class="text-sm">Ciphertext (dari QR):</label>
      <textarea
        id="ciphertextInput"
        rows="4"
        class="w-full border px-2 py-1 rounded"
      ></textarea>
    </div>

    <button
      onclick="decrypt()"
      class="bg-red-600 text-white px-4 py-2 rounded w-full mb-4"
    >
      ğŸ”“ Decrypt
    </button>

    <div>
      <label class="text-sm">Plaintext Hasil Dekripsi:</label>
      <textarea
        id="decryptedText"
        rows="2"
        class="w-full border px-2 py-1 rounded bg-gray-100"
        readonly
      ></textarea>
    </div>
  </div>

  <script>
    // Hardcoded username-password list
    const validUsers = {
      "kripto": "kripto123",
    };

    function login() {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();

      if (validUsers[username] && validUsers[username] === password) {
        // Hide login, show main app
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("appSection").style.display = "block";
        document.getElementById("loginError").style.display = "none";
      } else {
        document.getElementById("loginError").style.display = "block";
      }
    }

    // RSA & QR code functions below

    function gcd(a, b) {
      while (b !== 0) [a, b] = [b, a % b];
      return a;
    }

    function modInverse(e, phi) {
      let [a, b, u] = [0, phi, 1];
      while (e > 0) {
        let q = Math.floor(b / e);
        [a, b, u, e] = [u, e, a - q * u, b - q * e];
      }
      if (b !== 1) return null;
      return (a + phi) % phi;
    }

    function calculateKeys() {
      const p = parseInt(document.getElementById("p").value);
      const q = parseInt(document.getElementById("q").value);
      const e = parseInt(document.getElementById("e").value);
      if (!p || !q || !e) throw "Isi semua nilai p, q, dan e";

      const n = p * q;
      const phi = (p - 1) * (q - 1);
      if (gcd(e, phi) !== 1) throw "e tidak coprime dengan Ï†(n)";

      const d = modInverse(e, phi);
      if (d === null) throw "Tidak ditemukan invers modular";

      document.getElementById("n").value = n;
      document.getElementById("d").value = d;
    }

    function encrypt() {
      try {
        calculateKeys();
        const plaintext = document.getElementById("plaintext").value;
        const e = parseInt(document.getElementById("e").value);
        const n = parseInt(document.getElementById("n").value);

        const ciphertext = Array.from(plaintext)
          .map((ch) => {
            const m = BigInt(ch.charCodeAt(0));
            const c = (m ** BigInt(e)) % BigInt(n);
            return c.toString();
          })
          .join(" ");

        QRCode.toCanvas(
          document.getElementById("qrcode-canvas"),
          ciphertext,
          function (error) {
            if (error) console.error(error);
          }
        );

        document.getElementById("ciphertextInput").value = "";
      } catch (err) {
        alert(err);
      }
    }

    function downloadQR() {
      const canvas = document.getElementById("qrcode-canvas");
      const link = document.createElement("a");
      link.href = canvas.toDataURL("image/png");
      link.download = "qr_ciphertext.png";
      link.click();
    }

    function scanQR(event) {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onload = function () {
        const img = new Image();
        img.onload = function () {
          const canvas = document.createElement("canvas");
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0);
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, canvas.width, canvas.height);
          if (code) {
            document.getElementById("ciphertextInput").value = code.data;
            alert("QR Code berhasil discan dari file!");
          } else {
            alert("QR Code tidak terbaca");
          }
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    }

    let videoStream = null;
    let scanning = false;

    function startCameraScan() {
      const video = document.getElementById("video");
      if (scanning) return;

      navigator.mediaDevices
        .getUserMedia({ video: { facingMode: "environment" } })
        .then((stream) => {
          videoStream = stream;
          video.srcObject = stream;
          video.style.display = "block";

          document.getElementById("stopScanBtn").style.display = "block";

          video.onloadedmetadata = () => {
            video.play();
            scanning = true;
            scanVideoFrame();
          };
        })
        .catch((err) => {
          alert("Gagal akses kamera: " + err);
        });
    }

    function scanVideoFrame() {
      if (!scanning) return;

      const video = document.getElementById("video");
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, canvas.width, canvas.height);

        if (code) {
          document.getElementById("ciphertextInput").value = code.data;
          alert("QR Code berhasil discan dari kamera!");
          stopCameraScan();
          return;
        }
      }
      requestAnimationFrame(scanVideoFrame);
    }

    function stopCameraScan() {
      scanning = false;
      const video = document.getElementById("video");
      if (videoStream) {
        videoStream.getTracks().forEach((track) => track.stop());
      }
      video.srcObject = null;
      video.style.display = "none";
      document.getElementById("stopScanBtn").style.display = "none";
    }

    function decrypt() {
      const ciphertext = document
        .getElementById("ciphertextInput")
        .value.trim()
        .split(" ");
      const d = BigInt(document.getElementById("d").value);
      const n = BigInt(document.getElementById("n").value);
      if (!d || !n || ciphertext.length === 0)
        return alert("Isi kunci dan ciphertext terlebih dahulu");

      try {
        const chars = ciphertext.map((c) => {
          const m = (BigInt(c) ** d) % n;
          return String.fromCharCode(Number(m));
        });
        document.getElementById("decryptedText").value = chars.join("");
      } catch (err) {
        alert("Gagal dekripsi. Pastikan ciphertext valid dan kunci benar.");
      }
    }
  </script>
</body>
</html>
